# Incoming Call Implementation with CallKeep + Config Plugins

**Last Updated:** 2025-11-05
**Status:** IMPLEMENTATION COMPLETE - READY FOR EAS BUILD TESTING

## Problem Summary
Initial approach of creating custom native Kotlin/Swift modules failed because:
1. Native code was placed in ephemeral `android/`/`ios/` directories
2. These directories are gitignored and regenerated by `expo prebuild`
3. Custom native code doesn't survive EAS builds

## Solution
Use existing **react-native-callkeep** library with Expo config plugins:
- **Android:** ConnectionService (native incoming call UI) via CallKeep
- **iOS:** CallKit (Apple's official framework) via CallKeep
- **Config Plugin:** `@config-plugins/react-native-callkeep` (installed & configured)
- **VoIP Push:** `react-native-voip-push-notification` installed (custom plugin deferred)
- **EAS Compatible:** Config plugins survive prebuild and work with EAS builds
- **Comprehensive Logging:** Debug logs added throughout call flow

---

## Implementation Status

### ‚úÖ Phase 1: CallKeep Library Integration (COMPLETED)

**Approach:** Use existing `react-native-callkeep` library with config plugin instead of custom native modules.

**Reason:** Custom Kotlin/Swift modules in ephemeral `android/`/`ios/` directories don't survive EAS builds.

**What Config Plugin Provides:**

**Android:**
- Adds ConnectionService permissions to AndroidManifest
- Registers `VoiceConnectionService` service
- Registers `RNCallKeepBackgroundMessagingService`
- Adds required permissions: `BIND_TELECOM_CONNECTION_SERVICE`, `FOREGROUND_SERVICE`, `READ_PHONE_STATE`, `CALL_PHONE`

**iOS:**
- Adds "voip" to UIBackgroundModes
- Links `CallKit.framework` and `Intents.framework`
- Sets up header search paths for native CallKeep files

---

### ‚úÖ Phase 2: React Native Integration (COMPLETED)

#### ‚úÖ services/CallKeepService.ts
**Status:** Already existed - reused and enhanced

Wrapper around `react-native-callkeep` providing:
- Platform-agnostic API for displaying incoming calls
- Event handler registration (`setOnAnswer`, `setOnEnd`, `setOnToggleMute`)
- Call state management (`displayIncomingCall`, `answerIncoming`, `rejectCall`, `endCall`)
- Permission checking and initialization

**Added comprehensive logging:**
- Initialization steps with platform info
- Display call parameters and native call states
- Event handler execution flow
- Error tracking

#### ‚úÖ services/backgroundNotificationTask.ts
**Status:** Updated to use CallKeep

**Changes:**
- Replaced custom `IncomingCallManager` with `callKeepService`
- Calls `callKeepService.displayIncomingCall()` when intercom call detected
- Fallback to local notification if CallKeep fails

**Added logging:**
- Task trigger with timestamp
- Notification data extraction (with fallbacks)
- CallKeep integration status

#### ‚úÖ hooks/useAgora.ts
**Status:** Reverted to CallKeep event handlers

**Changes:**
- Uses `callKeepService.setOnAnswer()` to handle answer events
- Uses `callKeepService.setOnEnd()` to handle decline/end events
- Uses `callKeepService.setOnToggleMute()` to handle mute toggle
- All `IncomingCallManager.endCall()` replaced with `callKeepService.endCall()`

**Call Flow:**
```
Push Notification (FCM/VoIP Push)
  ‚Üì
backgroundNotificationTask receives notification
  ‚Üì
Extracts call data (callId, callerName, channel, etc.)
  ‚Üì
callKeepService.displayIncomingCall()
  ‚Üì
Native UI shows (ConnectionService on Android, CallKit on iOS)
  ‚Üì
User taps "Answer" ‚Üí CallKeep fires onAnswer event
  ‚Üì
useAgora.setOnAnswer handler ‚Üí answerIncomingCall()
  ‚Üì
API call to get Agora tokens ‚Üí Join Agora channel
  ‚Üì
Call connected
```

**Added logging:**
- CallKeep initialization
- Answer/End event handler execution
- `answerIncomingCall()` step-by-step flow
- State dumps for debugging

---

### ‚úÖ Phase 3: Dependencies & Configuration (COMPLETED)

#### ‚úÖ package.json
**Added:**
- `react-native-voip-push-notification: ^3.3.2` (for iOS VoIP push tokens)

**Already had:**
- `react-native-callkeep: ^4.3.16`
- `@config-plugins/react-native-callkeep: ^12.0.0`

#### ‚úÖ app.json
**Already configured:**
- Line 30: `@config-plugins/react-native-callkeep` plugin
- Lines 66-69: iOS `UIBackgroundModes` includes "voip" and "remote-notification"

#### ‚úÖ pnpm install
**Status:** Completed successfully
- `react-native-voip-push-notification` now installed in node_modules

---

### ‚è≥ Phase 4: iOS VoIP Push Config Plugin (DEFERRED)

**Status:** Deferred until after testing FCM-based implementation

**Reason:**
- No official config plugin exists for `react-native-voip-push-notification`
- Creating custom plugin requires AppDelegate modifications
- Can test with FCM first (Android) and foreground/background states (iOS)
- VoIP push only needed for iOS killed state

**What's needed when implemented:**
1. Custom Expo config plugin that modifies AppDelegate
2. Implements PushKit delegate methods
3. Registers VoIP push token with backend
4. Backend sends VoIP push instead of FCM for iOS

---

### ‚è≥ Phase 5: Testing (PENDING)

#### Test Preparation
1. ‚è≥ Run `npx expo prebuild --clean` to regenerate native directories
2. ‚è≥ Build with EAS: `eas build --platform android --profile preview`
3. ‚è≥ Build with EAS: `eas build --platform ios --profile preview`
4. ‚è≥ Install builds on physical devices

#### Android Testing Scenarios
1. ‚è≥ App foreground ‚Üí Push notification ‚Üí CallKeep UI shows ‚Üí Accept works
2. ‚è≥ App background ‚Üí Push notification ‚Üí CallKeep UI shows ‚Üí Accept works
3. ‚è≥ Device locked ‚Üí Push notification ‚Üí Shows over lockscreen ‚Üí Accept unlocks & connects
4. ‚è≥ Decline button dismisses correctly
5. ‚è≥ Multiple rapid calls don't crash
6. ‚è≥ Check logs for complete flow visibility
7. ‚è≥ Test on different manufacturers:
   - Samsung (One UI)
   - Xiaomi (MIUI) - check autostart settings
   - Google Pixel (baseline)

#### iOS Testing Scenarios
1. ‚è≥ App foreground ‚Üí Push notification ‚Üí CallKit UI shows ‚Üí Accept works
2. ‚è≥ App background ‚Üí Push notification ‚Üí CallKit UI shows ‚Üí Accept works
3. ‚è≥ Device locked ‚Üí Push notification ‚Üí Shows on lockscreen ‚Üí Accept works
4. ‚è≥ Decline button dismisses correctly
5. ‚è≥ Check logs for complete flow visibility
6. ‚è≥ **NOTE:** Killed state won't work until VoIP push config plugin implemented

#### Backend Verification
Ensure FCM payload format:
```json
{
  "to": "[fcm_token]",
  "priority": "high",
  "data": {
    "type": "intercom_call",
    "callId": "...",
    "from": "...",
    "fromName": "...",
    "apartmentNumber": "...",
    "channelName": "..."
  }
}
```
**CRITICAL:** No `notification` object! Only `data` for background task to trigger.

---

## Key Technical Decisions

### Why CallKeep Library Over Custom Native Code
- **EAS Build Compatibility:** Config plugins survive prebuild, custom native code doesn't
- **Maintained Solution:** react-native-callkeep is actively maintained and battle-tested
- **Cross-Platform:** Single API works for both ConnectionService (Android) and CallKit (iOS)
- **Apple Compliance:** CallKeep handles iOS 13+ requirement to report calls immediately

### Android Architecture
- **ConnectionService:** Android's official telecom framework (via CallKeep)
- **Background Service:** CallKeep handles service lifecycle automatically
- **Data-only FCM:** Ensures background task fires when app backgrounded/killed
- **High-Priority Push:** Wakes device from Doze mode

### iOS Architecture
- **CallKit:** Apple's official call UI framework (via CallKeep)
- **VoIP Push:** PushKit for reliable wake-up when app killed (pending custom plugin)
- **Background Modes:** "voip" and "remote-notification" already configured

### Integration Architecture
- **Event-Driven:** CallKeep events ‚Üí useAgora handlers ‚Üí Agora SDK
- **Background Task:** Expo TaskManager receives push ‚Üí CallKeep displays UI
- **AsyncStorage:** Bridges notification data from background task to React state

### Files Modified/Created

**Dependencies:**
- `package.json` - Added `react-native-voip-push-notification: ^3.3.2`

**Configuration:**
- `app.json` - Already had CallKeep config plugin configured

**React Native/TypeScript:**
- `services/CallKeepService.ts` (**enhanced** with comprehensive logging)
- `services/backgroundNotificationTask.ts` (**modified** to use CallKeep)
- `hooks/useAgora.ts` (**modified** to use CallKeep event handlers)

**Deleted (not EAS-compatible):**
- `services/IncomingCallManager.ts` (custom native wrapper)
- `components/CallPermissionsSetup.tsx` (not needed with CallKeep)
- All custom Kotlin modules (IncomingCallActivity, IncomingCallService, etc.)

**Documentation:**
- `PLAN.md` (this file)

---

## Debugging Guide

### Comprehensive Logging Added
All components now have detailed logs with emojis for easy filtering:
- `[CallKeep]` - CallKeep service operations
- `[BackgroundTask]` - Background notification task
- `[useAgora]` - Agora integration and event handlers

**How to debug:**
```bash
# Android
adb logcat | grep -E "\[CallKeep\]|\[BackgroundTask\]|\[useAgora\]"

# iOS (using Xcode Console or device logs)
# Filter by: CallKeep, BackgroundTask, or useAgora
```

### Issue: CallKeep UI doesn't show

**Android:**
- Check if `@config-plugins/react-native-callkeep` is in app.json plugins
- Run `npx expo prebuild --clean` to regenerate AndroidManifest
- Check logs for `[CallKeep] displayIncomingCall()` being called
- Verify ConnectionService permissions were added

**iOS:**
- Check if UIBackgroundModes includes "voip" (should be auto-added)
- Check logs for `[CallKeep] displayIncomingCall()` being called
- Verify CallKit framework was linked

### Issue: Background task doesn't fire
**Check:**
- FCM payload uses `data` only (no `notification` object)
- Background task registered: `BACKGROUND-NOTIFICATION-TASK`
- Logs show `[BackgroundTask] üéØ TASK TRIGGERED`
- Notification data extraction logs show correct format

### Issue: Answer button doesn't connect call
**Check:**
- Logs show `[CallKeep] üéØ onAnswerCall EVENT FIRED`
- Logs show `[useAgora] üéØ ANSWER HANDLER TRIGGERED`
- Logs show `answerIncomingCall()` step progression
- Agora tokens are valid (check API response logs)
- RTM login succeeds
- Network connectivity present

### Issue: App doesn't wake from killed state

**Android:**
- FCM high-priority push should wake app
- Check battery optimization settings
- Test on different Android versions (manufacturer differences)

**iOS:**
- **Expected:** Won't work until VoIP push config plugin implemented
- Regular FCM doesn't reliably wake iOS from killed state
- Need PushKit (VoIP push) for killed state support

---

## Progress Summary

**Completed:** 8/10 phases
- ‚úÖ CallKeep library integration
- ‚úÖ React Native integration (CallKeepService, backgroundNotificationTask, useAgora)
- ‚úÖ Dependencies installed (react-native-voip-push-notification)
- ‚úÖ Configuration verified (app.json, config plugin)
- ‚úÖ Comprehensive logging added
- ‚úÖ Custom native code deleted (not EAS-compatible)
- ‚úÖ Documentation updated (PLAN.md)
- ‚úÖ pnpm install completed

**Pending:** 2/10 phases
- ‚è≥ iOS VoIP push config plugin (deferred - test FCM first)
- ‚è≥ Testing on physical devices with EAS builds

---

## Next Steps

### Immediate (Ready for Testing)
1. **Prebuild native directories:**
   ```bash
   cd /Users/sandragreidinger/dev/porteiroapp/apps/expo
   npx expo prebuild --clean
   ```

2. **Build with EAS:**
   ```bash
   # Android
   eas build --platform android --profile preview

   # iOS
   eas build --platform ios --profile preview
   ```

3. **Test on physical devices:**
   - Install builds from EAS
   - Trigger incoming call via backend
   - Check logs for complete flow visibility
   - Verify CallKeep UI shows and accepts work

### Future (After Initial Testing)
4. **iOS VoIP Push Config Plugin** (if killed state needed):
   - Create custom Expo config plugin
   - Modify AppDelegate for PushKit integration
   - Update backend to send VoIP push for iOS

5. **Backend FCM Payload Verification:**
   - Ensure `data` only, no `notification` object
   - High priority setting
   - Correct field names (callId, fromName, channelName, etc.)

---

## Unresolved Questions

None - Implementation complete and ready for EAS build testing.
